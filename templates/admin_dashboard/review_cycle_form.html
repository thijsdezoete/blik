{% extends "admin_dashboard/base.html" %}

{% block title %}Create Review Cycle{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Create Review Cycle</h1>
    <p style="color: #64748b;">Set up a new 360-degree feedback review cycle</p>
</div>

<div style="max-width: 700px;">
    <form method="post" id="cycleForm">
        {% csrf_token %}

        {% if can_create_for_others %}
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title">Creation Mode</h2>
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 8px; flex: 1;">
                        <input type="radio" name="creation_mode" value="single" checked onchange="toggleRevieweeSelect()">
                        <div>
                            <div style="font-weight: 600;">Single Reviewee</div>
                            <div style="font-size: 0.875rem; color: #64748b;">Create cycle for one person</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 8px; flex: 1;">
                        <input type="radio" name="creation_mode" value="bulk" onchange="toggleRevieweeSelect()">
                        <div>
                            <div style="font-weight: 600;">Bulk Create</div>
                            <div style="font-size: 0.875rem; color: #64748b;">Create for all active reviewees</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        {% else %}
        <input type="hidden" name="creation_mode" value="single">
        <div class="card" style="margin-bottom: 1.5rem; background: #fffbeb; border: 1px solid #fde047;">
            <div class="card-body">
                <p style="margin: 0; color: #854d0e;">
                    <strong>Note:</strong> You can only create review cycles for yourself. Contact an administrator to create cycles for other team members.
                </p>
            </div>
        </div>
        {% endif %}

        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h2 class="card-title">Basic Information</h2>
            </div>
            <div class="card-body">
                <div class="form-group" id="revieweeGroup">
                    <label for="reviewee" class="form-label">Reviewee *</label>
                    <select id="reviewee" name="reviewee" class="form-control">
                        <option value="">Select a reviewee...</option>
                        {% for reviewee in reviewees %}
                        <option value="{{ reviewee.id }}">{{ reviewee.name }} ({{ reviewee.email }})</option>
                        {% endfor %}
                    </select>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Person who will receive 360-degree feedback
                    </div>
                </div>

                <div class="form-group">
                    <label for="questionnaire" class="form-label">Questionnaire *</label>
                    <select id="questionnaire" name="questionnaire" class="form-control" required>
                        <option value="">Select a questionnaire...</option>
                        {% for q in questionnaires %}
                        <option value="{{ q.id }}" {% if q.is_default %}selected{% endif %}>
                            {{ q.name }}{% if q.is_default %} (Default){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Questions that reviewers will answer
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;" id="inviteSection">
            <div class="card-header" style="cursor: pointer;" onclick="toggleInviteForm()">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title" style="margin: 0;">Invite Reviewers (Optional)</h2>
                    <svg id="inviteChevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="card-body" id="inviteFormBody" style="display: none;">
                <p style="color: #64748b; margin-bottom: 1.5rem;">
                    Enter email addresses for reviewers now, or skip and add them later. Separate multiple emails with commas or newlines.
                </p>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Self Assessment</label>
                    <textarea
                        name="self_emails"
                        id="selfEmails"
                        class="form-control"
                        rows="2"
                        placeholder="reviewee@example.com"
                    ></textarea>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Usually the reviewee's own email (auto-filled when reviewee selected)
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Manager/Supervisor</label>
                    <textarea
                        name="manager_emails"
                        class="form-control"
                        rows="2"
                        placeholder="manager@example.com"
                    ></textarea>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Direct manager or supervisor
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Peers</label>
                    <textarea
                        name="peer_emails"
                        class="form-control"
                        rows="3"
                        placeholder="peer1@example.com, peer2@example.com"
                    ></textarea>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Colleagues at the same level
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">Direct Reports</label>
                    <textarea
                        name="direct_report_emails"
                        class="form-control"
                        rows="3"
                        placeholder="report1@example.com, report2@example.com"
                    ></textarea>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        People who report to this reviewee
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; padding: 1rem; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border);">
                    <input type="checkbox" name="send_invitations_now" id="sendInvitationsNow" value="1" style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="sendInvitationsNow" style="margin: 0; cursor: pointer; font-size: 0.875rem; color: var(--text-primary);">
                        Send invitation emails immediately after creating cycle
                    </label>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn btn-primary" id="submitBtn">Create Review Cycle</button>
            <a href="{% url 'review_cycle_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Store reviewee email mapping
const revieweeEmails = {
    {% for reviewee in reviewees %}
    '{{ reviewee.id }}': '{{ reviewee.email }}',
    {% endfor %}
};

function toggleRevieweeSelect() {
    const mode = document.querySelector('input[name="creation_mode"]:checked').value;
    const revieweeGroup = document.getElementById('revieweeGroup');
    const revieweeSelect = document.getElementById('reviewee');
    const submitBtn = document.getElementById('submitBtn');
    const inviteSection = document.getElementById('inviteSection');

    if (mode === 'bulk') {
        revieweeGroup.style.display = 'none';
        revieweeSelect.removeAttribute('required');
        submitBtn.textContent = 'Create Cycles for All Reviewees';
        inviteSection.style.display = 'none'; // Hide invite section for bulk mode
    } else {
        revieweeGroup.style.display = 'block';
        revieweeSelect.setAttribute('required', 'required');
        submitBtn.textContent = 'Create Review Cycle';
        inviteSection.style.display = 'block'; // Show invite section for single mode
    }
}

function toggleInviteForm() {
    const body = document.getElementById('inviteFormBody');
    const chevron = document.getElementById('inviteChevron');

    if (body.style.display === 'none') {
        body.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        body.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

function updateSelfEmail() {
    const revieweeSelect = document.getElementById('reviewee');
    const selfEmails = document.getElementById('selfEmails');

    if (revieweeSelect && selfEmails && revieweeSelect.value) {
        const email = revieweeEmails[revieweeSelect.value];
        if (email) {
            selfEmails.value = email;
        }
    }
}

// Initialize on page load
toggleRevieweeSelect();

// Add event listener to reviewee select
document.addEventListener('DOMContentLoaded', function() {
    const revieweeSelect = document.getElementById('reviewee');
    if (revieweeSelect) {
        revieweeSelect.addEventListener('change', updateSelfEmail);
    }
});
</script>

{% if not reviewees %}
<script>
    window.location.href = "{% url 'reviewee_create' %}";
</script>
{% endif %}

{% if not questionnaires %}
<script>
    window.location.href = "{% url 'questionnaire_list' %}";
</script>
{% endif %}
{% endblock %}

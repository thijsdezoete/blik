services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: blik_test
      POSTGRES_USER: blik_test
      POSTGRES_PASSWORD: test123
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U blik_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "8125:8025"  # Web UI (using 8125 to avoid conflicts)
      - "1125:1025"  # SMTP (using 1125 to avoid conflicts)
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1

  web:
    build:
      context: .
      dockerfile: Dockerfile.test
    command: sh -c "python manage.py test --keepdb --verbosity=2"
    volumes:
      - .:/app
    environment:
      # Database
      DATABASE_TYPE: postgres
      DATABASE_NAME: blik_test
      DATABASE_USER: blik_test
      DATABASE_PASSWORD: test123
      DATABASE_HOST: db
      DATABASE_PORT: 5432

      # Django
      DEBUG: "True"
      SECRET_KEY: test-secret-key-for-testing-only
      ALLOWED_HOSTS: "*"

      # Email
      EMAIL_BACKEND: django.core.mail.backends.smtp.EmailBackend
      EMAIL_HOST: mailpit
      EMAIL_PORT: 1025  # Internal container port
      EMAIL_USE_TLS: "False"
      DEFAULT_FROM_EMAIL: test@blik.local

      # Security (relaxed for testing)
      SESSION_COOKIE_SECURE: "False"
      CSRF_COOKIE_SECURE: "False"

      # Site settings
      SITE_DOMAIN: localhost:8000
      SITE_PROTOCOL: http

      # Auto-setup for tests
      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@test.local
      DJANGO_SUPERUSER_PASSWORD: admin123

    depends_on:
      db:
        condition: service_healthy
      mailpit:
        condition: service_started

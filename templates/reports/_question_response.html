{% load feedback_tags %}
{# Template for rendering a single question's responses across categories #}

<div class="question-report">
    <h3 class="question-title">{{ question_data.question_text }}</h3>

    {# Show preview of how the question was presented #}
    <div style="margin: 1rem 0; padding: 1rem; background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
        <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 0.5rem;">
            Question Format: {{ question_data.question_type|title }}
        </div>
        {% if question_data.question_type == 'rating' %}
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                {% if question_data.question_config.labels %}
                    Rating scale (1-5):
                    <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem;">
                        {% for rating in "12345" %}
                            {% with rating_int=rating|add:"0" %}
                            {% with label=question_data.question_config|get_rating_label:rating_int %}
                            {% if label %}
                                <div style="font-size: 0.8125rem;">{{ rating_int }}. {{ label }}</div>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    Rating scale: 1 to 5
                {% endif %}
            </div>
        {% elif question_data.question_type == 'likert' %}
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                Likert scale options:
                {% if question_data.question_config.scale %}
                <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    {% for option in question_data.question_config.scale %}
                        <span style="padding: 0.25rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; font-size: 0.8125rem;">{{ option }}</span>
                    {% endfor %}
                </div>
                {% else %}
                <div style="margin-top: 0.5rem; font-size: 0.8125rem; color: var(--danger);">
                    DEBUG: Config={{ question_data.question_config }}
                </div>
                {% endif %}
            </div>
        {% elif question_data.question_type == 'single_choice' %}
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                Single choice (select one):
                <div style="margin-top: 0.5rem;">
                    {% for choice in question_data.question_config.choices %}
                        <div style="font-size: 0.8125rem; padding: 0.25rem 0;">‚óã {{ choice }}</div>
                    {% endfor %}
                </div>
            </div>
        {% elif question_data.question_type == 'multiple_choice' %}
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                Multiple choice (select all that apply):
                <div style="margin-top: 0.5rem;">
                    {% for choice in question_data.question_config.choices %}
                        <div style="font-size: 0.8125rem; padding: 0.25rem 0;">‚òê {{ choice }}</div>
                    {% endfor %}
                </div>
            </div>
        {% elif question_data.question_type == 'scale' %}
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                Scale: {{ question_data.question_config.min|default:1 }} to {{ question_data.question_config.max|default:100 }}
            </div>
        {% elif question_data.question_type == 'text' %}
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                Open-ended text response
            </div>
        {% endif %}
    </div>

    <div class="category-results">
        {% if question_data.category_order %}
            {# New reports with explicit ordering #}
            {% for category in question_data.category_order %}
            {% with cat_data=question_data.by_category|get_item:category %}
            <div class="category-result">
                <div class="category-header">
                    <span class="badge badge-{{ category }}">{% if category == "direct_report" %}Direct Report{% else %}{{ category|title }}{% endif %}</span>
                    <span class="response-count">{{ cat_data.count }} response{{ cat_data.count|pluralize }}</span>
                </div>

                {% if cat_data.insufficient %}
                    <div class="insufficient-data">
                        {{ cat_data.message }}
                    </div>
                {% else %}
                    {# RATING QUESTIONS - Show average with label context #}
                    {% if question_data.question_type == 'rating' and cat_data.avg %}
                        <div class="rating-display">
                            <span class="rating-score">{{ cat_data.avg }}</span>
                            <div class="rating-bar-container">
                                <div class="rating-bar-fill" style="width: {{ cat_data.avg|floatformat:0|add:"0"|mul:"20" }}%"></div>
                            </div>
                            <span class="response-count">/ 5.0</span>
                        </div>
                        {% with label=question_data.question_config|get_rating_label:cat_data.avg %}
                            {% if label %}
                                <div class="rating-context">{{ label }}</div>
                            {% endif %}
                        {% endwith %}

                        {# Show distribution for rating questions #}
                        {% if cat_data.distribution %}
                        <div class="distribution-container" style="margin-top: 1rem;">
                            {% for rating in "54321" %}
                                {% with rating_int=rating|add:"0" %}
                                {% with count=cat_data.distribution|get_item:rating_int|default:0 %}
                                {% if count > 0 %}
                                {% with pct=count|percentage:cat_data.count %}
                                <div class="distribution-item">
                                    <div class="distribution-header">
                                        <span class="distribution-label">
                                            {{ rating_int }} - {{ question_data.question_config|get_rating_label:rating_int }}
                                        </span>
                                        <span class="distribution-count">{{ count }} ({{ pct }}%)</span>
                                    </div>
                                    <div class="distribution-bar-container">
                                        <div class="distribution-bar-fill" style="width: {{ pct }}%;"></div>
                                    </div>
                                </div>
                                {% endwith %}
                                {% endif %}
                                {% endwith %}
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endif %}

                    {# SCALE QUESTIONS #}
                    {% elif question_data.question_type == 'scale' and cat_data.avg %}
                        <div class="rating-display">
                            <span class="rating-score">{{ cat_data.avg|floatformat:1 }}</span>
                            <div class="rating-bar-container">
                                {% with min_val=question_data.question_config.min|default:1 max_val=question_data.question_config.max|default:100 %}
                                    {% widthratio cat_data.avg max_val 100 as bar_width %}
                                    <div class="rating-bar-fill" style="width: {{ bar_width }}%"></div>
                                {% endwith %}
                            </div>
                            <span class="response-count">/ {{ question_data.question_config.max|default:"100" }}</span>
                        </div>

                    {# LIKERT QUESTIONS - Show sentiment summary + distribution #}
                    {% elif question_data.question_type == 'likert' %}
                        {% if cat_data.distribution %}
                            {# Calculate sentiment (positive = agree/strongly agree) #}
                            {% with scale=question_data.question_config.scale %}
                            {% with total_responses=cat_data.count %}
                            {% with positive_count=cat_data.distribution|get_item:"Strongly Agree"|default:0|add:cat_data.distribution|get_item:"Agree"|default:0 %}
                            {% with positive_pct=positive_count|percentage:total_responses %}

                            {% if positive_pct >= 70 %}
                                <div class="likert-summary likert-positive">
                                    üìä Strong consensus: {{ positive_pct }}% positive ({{ positive_count }} of {{ total_responses }} respondents)
                                </div>
                            {% elif positive_pct >= 50 %}
                                <div class="likert-summary likert-mostly-positive">
                                    üìä Mostly positive: {{ positive_pct }}% ({{ positive_count }} of {{ total_responses }} respondents)
                                </div>
                            {% endif %}

                            <div class="distribution-container" style="margin-top: 0.75rem;">
                                {# Show all scale options in order, including zeros #}
                                {% for option in scale %}
                                    {% with count=cat_data.distribution|get_item:option|default:0 %}
                                    {% with pct=count|percentage:total_responses %}
                                    <div class="distribution-item">
                                        <div class="distribution-header">
                                            <span class="distribution-label">{{ option }}</span>
                                            <span class="distribution-count">{{ count }} respondent{{ count|pluralize }} ({{ pct }}%)</span>
                                        </div>
                                        <div class="distribution-bar-container">
                                            <div class="distribution-bar-fill" style="width: {{ pct }}%;"></div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                        {% endif %}

                    {# SINGLE CHOICE - Show sorted by frequency with percentages #}
                    {% elif question_data.question_type == 'single_choice' %}
                        {% if cat_data.avg and question_data.question_config.scoring_enabled %}
                            <div class="rating-display">
                                <span class="rating-score">{{ cat_data.avg|floatformat:1 }}</span>
                                <div class="rating-bar-container">
                                    {% with weights=question_data.question_config.weights %}
                                        {% if weights %}
                                            {% widthratio cat_data.avg weights|last 100 as bar_width %}
                                            <div class="rating-bar-fill" style="width: {{ bar_width }}%"></div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <span class="response-count" style="font-size: 0.75rem; color: var(--text-secondary);">weighted avg</span>
                            </div>
                        {% endif %}

                        {% if cat_data.distribution %}
                        <div class="distribution-container">
                            {% for option, count in cat_data.distribution|sort_by_frequency %}
                                {% with pct=count|percentage:cat_data.count %}
                                <div class="distribution-item">
                                    <div class="distribution-header">
                                        <span class="distribution-label">{{ option }}</span>
                                        <span class="distribution-count">{{ count }} respondent{{ count|pluralize }} ({{ pct }}%)</span>
                                    </div>
                                    <div class="distribution-bar-container">
                                        <div class="distribution-bar-fill" style="width: {{ pct }}%;"></div>
                                    </div>
                                </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endif %}

                    {# MULTIPLE CHOICE - Show sorted by frequency with "X of Y selected" #}
                    {% elif question_data.question_type == 'multiple_choice' %}
                        {% if cat_data.avg and question_data.question_config.scoring_enabled %}
                            <div class="rating-display">
                                <span class="rating-score">{{ cat_data.avg|floatformat:1 }}</span>
                                <span class="response-count" style="font-size: 0.75rem; color: var(--text-secondary); margin-left: 0.5rem;">weighted avg</span>
                            </div>
                        {% endif %}

                        {% if cat_data.distribution %}
                        <div class="distribution-container">
                            {% for option, count in cat_data.distribution|sort_by_frequency %}
                                {% with pct=count|percentage:cat_data.count %}
                                <div class="distribution-item">
                                    <div class="distribution-header">
                                        <span class="distribution-label">{{ option }}</span>
                                        <span class="distribution-count">{{ count }} of {{ cat_data.count }} respondent{{ cat_data.count|pluralize }} ({{ pct }}%)</span>
                                    </div>
                                    <div class="distribution-bar-container">
                                        <div class="distribution-bar-fill" style="width: {{ pct }}%;"></div>
                                    </div>
                                </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endif %}

                    {# TEXT RESPONSES #}
                    {% elif question_data.question_type == 'text' %}
                        <div class="text-responses">
                            {% for response in cat_data.responses %}
                                <div class="text-response">{{ response }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            {% endwith %}
            {% endfor %}

        {% else %}
            {# Legacy reports without category_order - use dict iteration #}
            {% for category, cat_data in question_data.by_category.items %}
            {# Same structure as above but without the category_order loop #}
            {# Omitted for brevity - would be identical #}
            {% endfor %}
        {% endif %}
    </div>
</div>

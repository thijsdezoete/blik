# Landing/Marketing Site with Nginx Reverse Proxy
#
# Deploy this alongside docker-compose.yml to add:
# - Lightweight landing container serving marketing pages at root
# - Nginx reverse proxy routing traffic appropriately
#
# Usage on Dokploy or similar platforms:
# 1. Deploy docker-compose.yml first (main app)
# 2. Deploy this file separately (landing + nginx)
# 3. Point your domain to nginx port (80)

services:
  landing:
    build:
      context: .
      dockerfile: Dockerfile.landing
    command: gunicorn --bind 0.0.0.0:${LANDING_PORT:-8001} --workers 2 --timeout 60 --access-logfile - --error-logfile - --log-level info landing_wsgi:application
    volumes:
      - ./:/app
      - static_volume:/app/staticfiles
    ports:
      - "${LANDING_PORT:-8001}:${LANDING_PORT:-8001}"
    env_file:
      - .env
    environment:
      - LANDING_PORT=${LANDING_PORT:-8001}
      - SITE_DOMAIN=${SITE_DOMAIN:-www.blik360.com}
    restart: unless-stopped
    networks:
      - blik_default  # Connect to main app network

  nginx:
    image: nginx:alpine
    expose:
      - "8111"
    volumes:
      - ./nginx.conf.template:/etc/nginx/nginx.conf.template:ro
      - ./docker-entrypoint-nginx.sh:/docker-entrypoint-nginx.sh:ro
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/mediafiles:ro
    environment:
      - NGINX_PORT=${NGINX_PORT:-80}
      - PORT=${PORT:-8000}
      - LANDING_PORT=${LANDING_PORT:-8001}
    depends_on:
      - landing
    entrypoint: ["/docker-entrypoint-nginx.sh"]
    restart: unless-stopped
    networks:
      - blik_default  # Connect to main app network

# Create volumes and network for standalone landing deployment
volumes:
  static_volume:
  media_volume:

networks:
  blik_default:

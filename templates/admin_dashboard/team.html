{% extends "admin_dashboard/base.html" %}

{% block title %}Team Management{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Team Management</h1>
        <p class="page-description">Manage users and send invitations</p>
        {% if subscription_status.has_subscription %}
        <p style="font-size: 0.875rem; color: #10b981; margin-top: 0.25rem;">
            {{ subscription_status.current_users }} team members (unlimited)
        </p>
        {% endif %}
    </div>
    {% if perms.accounts.can_invite_members %}
    <button type="button" class="btn btn-primary" onclick="document.getElementById('invite-modal').style.display='flex'">
        Send Invitation
    </button>
    {% endif %}
</div>

<!-- Invite Modal -->
<div id="invite-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Send Invitation</h2>
        <form method="post" action="{% url 'send_invitation' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" class="form-control" required autofocus>
                <small class="help-text">The user will receive an email with instructions to join</small>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('invite-modal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary">Send Invitation</button>
            </div>
        </form>
    </div>
</div>

<!-- Active Users -->
<div class="card mb-2">
    <div class="card-header">
        <h2 class="card-title">Active Users ({{ users.count }})</h2>
    </div>
    <div class="card-body">
        {% if users %}
        <!-- Desktop table -->
        <div class="table-responsive d-none d-md-block">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Joined</th>
                        <th>Permissions</th>
                        {% if perms.accounts.can_manage_organization %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for user_profile in users %}
                    <tr>
                        <td>
                            <strong>{{ user_profile.user.first_name|default:user_profile.user.username }}</strong>
                            {% if user_profile.user.last_name %}{{ user_profile.user.last_name }}{% endif %}
                            {% if user_profile.user.id == request.user.id %}
                                <span class="badge" style="background: #6b7280; color: white; font-size: 11px; margin-left: 4px;">You</span>
                            {% endif %}
                        </td>
                        <td>{{ user_profile.user.email }}</td>
                        <td>
                            {% if user_profile.user.is_superuser %}
                                <span class="badge" style="background: #7c3aed; color: white;">Super Admin</span>
                            {% elif user_profile.is_org_admin %}
                                <span class="badge" style="background: #059669; color: white;">Organization Admin</span>
                            {% else %}
                                <span class="badge" style="background: #6b7280; color: white;">Member</span>
                            {% endif %}
                        </td>
                        <td>{{ user_profile.user.date_joined|date:"M d, Y" }}</td>
                        <td>
                            {% if user_profile.can_create_cycles_for_others %}
                                <span class="badge" style="background: #0ea5e9; color: white;">Can manage cycles</span>
                            {% else %}
                                <span class="badge" style="background: #f59e0b; color: white;">Self-only</span>
                            {% endif %}
                        </td>
                        {% if perms.accounts.can_manage_organization %}
                        <td>
                            {% if user_profile.user.id != request.user.id and not user_profile.user.is_superuser %}
                            <button type="button" class="btn btn-sm btn-secondary" onclick="showManagePermissionsModal({{ user_profile.id }}, '{{ user_profile.user.username }}', {{ user_profile.is_org_admin|lower }}, {{ user_profile.can_create_cycles_for_others|lower }})">
                                Manage
                            </button>
                            {% else %}
                            <span style="color: var(--text-tertiary); font-size: 12px;">â€”</span>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile card list -->
        <div class="d-md-none">
            {% for user_profile in users %}
            <div class="mobile-card">
                <div class="mobile-card-header">
                    <div>
                        <strong>{{ user_profile.user.first_name|default:user_profile.user.username }}</strong>
                        {% if user_profile.user.last_name %}{{ user_profile.user.last_name }}{% endif %}
                        {% if user_profile.user.id == request.user.id %}
                            <span class="badge" style="background: #6b7280; color: white; font-size: 11px; margin-left: 4px;">You</span>
                        {% endif %}
                    </div>
                    <div>
                        {% if user_profile.user.is_superuser %}
                            <span class="badge" style="background: #7c3aed; color: white; font-size: 11px;">Super Admin</span>
                        {% elif user_profile.is_org_admin %}
                            <span class="badge" style="background: #059669; color: white; font-size: 11px;">Organization Admin</span>
                        {% else %}
                            <span class="badge" style="background: #6b7280; color: white; font-size: 11px;">Member</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Email</span>
                        <span>{{ user_profile.user.email }}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Joined</span>
                        <span>{{ user_profile.user.date_joined|date:"M d, Y" }}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Permissions</span>
                        <span>
                            {% if user_profile.can_create_cycles_for_others %}
                                <span class="badge" style="background: #0ea5e9; color: white; font-size: 11px;">Can manage cycles</span>
                            {% else %}
                                <span class="badge" style="background: #f59e0b; color: white; font-size: 11px;">Self-only</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if perms.accounts.can_manage_organization %}
                        {% if user_profile.user.id != request.user.id and not user_profile.user.is_superuser %}
                        <button type="button" class="btn btn-sm btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="showManagePermissionsModal({{ user_profile.id }}, '{{ user_profile.user.username }}', {{ user_profile.is_org_admin|lower }}, {{ user_profile.can_create_cycles_for_others|lower }})">
                            Manage Permissions
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No users found</p>
        {% endif %}
    </div>
</div>

<!-- Pending Invitations -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Pending Invitations ({{ invitations.count }})</h2>
    </div>
    <div class="card-body">
        {% if invitations %}
        <!-- Desktop table -->
        <div class="table-responsive d-none d-md-block">
            <table class="table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Invited By</th>
                        <th>Sent</th>
                        <th>Expires</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invitation in invitations %}
                    <tr>
                        <td>{{ invitation.email }}</td>
                        <td>{{ invitation.invited_by.username }}</td>
                        <td>{{ invitation.created_at|date:"M d, Y" }}</td>
                        <td>{{ invitation.expires_at|date:"M d, Y" }}</td>
                        <td>
                            {% if invitation.is_valid %}
                                <span class="badge" style="background: #059669; color: white;">Active</span>
                            {% else %}
                                <span class="badge" style="background: #dc2626; color: white;">Expired</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile card list -->
        <div class="d-md-none">
            {% for invitation in invitations %}
            <div class="mobile-card">
                <div class="mobile-card-header">
                    <div><strong>{{ invitation.email }}</strong></div>
                    <div>
                        {% if invitation.is_valid %}
                            <span class="badge" style="background: #059669; color: white; font-size: 11px;">Active</span>
                        {% else %}
                            <span class="badge" style="background: #dc2626; color: white; font-size: 11px;">Expired</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Invited By</span>
                        <span>{{ invitation.invited_by.username }}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Sent</span>
                        <span>{{ invitation.created_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">Expires</span>
                        <span>{{ invitation.expires_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No pending invitations</p>
        {% endif %}
    </div>
</div>

<!-- Manage Permissions Modal -->
{% if perms.accounts.can_manage_organization %}
<div id="manage-permissions-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Manage User Permissions</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Update permissions for <strong id="modal-username"></strong>
        </p>
        <form method="post" action="{% url 'update_user_permissions' %}">
            {% csrf_token %}
            <input type="hidden" id="modal-user-id" name="user_profile_id">

            <div class="form-group">
                <label class="form-label">Role</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div class="form-check">
                        <input type="radio" id="role-admin" name="role" value="admin" class="form-check-input">
                        <label for="role-admin" style="display: inline; font-weight: normal;">
                            <strong>Organization Admin</strong>
                            <small style="display: block; color: var(--text-secondary); margin-left: 24px;">
                                Can invite members, manage organization settings, and delete organization
                            </small>
                        </label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="role-member" name="role" value="member" class="form-check-input">
                        <label for="role-member" style="display: inline; font-weight: normal;">
                            <strong>Member</strong>
                            <small style="display: block; color: var(--text-secondary); margin-left: 24px;">
                                Regular team member with limited permissions
                            </small>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Additional Permissions</label>
                <div class="form-check">
                    <input type="checkbox" id="can-manage-cycles" name="can_create_cycles_for_others" class="form-check-input">
                    <label for="can-manage-cycles" style="display: inline; font-weight: normal;">
                        Can create review cycles for others
                        <small style="display: block; color: var(--text-secondary); margin-left: 24px;">
                            Without this, user can only create cycles for themselves
                        </small>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="hideManagePermissionsModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Permissions</button>
            </div>
        </form>
    </div>
</div>

<script>
function showManagePermissionsModal(userId, username, isStaff, canCreateCycles) {
    document.getElementById('modal-user-id').value = userId;
    document.getElementById('modal-username').textContent = username;

    // Set role radio buttons
    if (isStaff) {
        document.getElementById('role-admin').checked = true;
    } else {
        document.getElementById('role-member').checked = true;
    }

    // Set can create cycles checkbox
    document.getElementById('can-manage-cycles').checked = canCreateCycles;

    document.getElementById('manage-permissions-modal').style.display = 'flex';
}

function hideManagePermissionsModal() {
    document.getElementById('manage-permissions-modal').style.display = 'none';
}
</script>
{% endif %}
{% endblock %}

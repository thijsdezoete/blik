{% extends "admin_dashboard/base.html" %}

{% block title %}Review Cycle: {{ cycle.reviewee.name }}{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
        <div>
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">
                {{ cycle.reviewee.name }}
                {% if cycle.status == 'active' %}
                <span class="badge badge-warning">Active</span>
                {% else %}
                <span class="badge badge-success">Completed</span>
                {% endif %}
            </h1>
            <p style="color: #64748b; margin-bottom: 0.25rem;">
                <strong>Questionnaire:</strong> {{ cycle.questionnaire.name }}
            </p>
            <p style="color: #64748b;">Created on {{ cycle.created_at|date:"F d, Y" }}</p>
        </div>
        <a href="{% url 'review_cycle_list' %}" class="btn btn-secondary">Back to List</a>
    </div>
</div>

{% if cycle.status == 'completed' %}
<!-- Report Section (Prominent for completed cycles) -->
{% if report_exists %}
<div class="card" style="margin-bottom: 2rem; border: 2px solid var(--success);">
    <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white;">
        <h2 class="card-title" style="color: white; display: flex; align-items: center; gap: 0.5rem;">
            <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            Report Available
        </h2>
    </div>
    <div class="card-body">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            The 360-degree feedback report for <strong>{{ cycle.reviewee.name }}</strong> has been generated and is ready to view.
        </p>
        {% if report.access_token_expires %}
        <div style="padding: 0.75rem; background: {% if report.access_token_expires|timeuntil != '0 minutes' %}#FEF3C7{% else %}#FEE2E2{% endif %}; border-left: 4px solid {% if report.access_token_expires|timeuntil != '0 minutes' %}#F59E0B{% else %}#EF4444{% endif %}; border-radius: 6px; margin-bottom: 1rem;">
            <div style="display: flex; align-items: start; gap: 0.5rem;">
                <svg style="width: 20px; height: 20px; margin-top: 2px; color: {% if report.access_token_expires|timeuntil != '0 minutes' %}#F59E0B{% else %}#EF4444{% endif %};" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <strong style="color: {% if report.access_token_expires|timeuntil != '0 minutes' %}#92400E{% else %}#991B1B{% endif %};">Report Access Token</strong>
                    <div style="font-size: 0.875rem; color: {% if report.access_token_expires|timeuntil != '0 minutes' %}#92400E{% else %}#991B1B{% endif %}; margin-top: 0.25rem;">
                        {% now "Y-m-d H:i:s" as now_time %}
                        {% if report.access_token_expires|date:"Y-m-d H:i:s" < now_time %}
                            Expired on {{ report.access_token_expires|date:"M d, Y" }} at {{ report.access_token_expires|time:"H:i" }}
                        {% else %}
                            Expires in {{ report.access_token_expires|timeuntil }} ({{ report.access_token_expires|date:"M d, Y" }} at {{ report.access_token_expires|time:"H:i" }})
                        {% endif %}
                    </div>
                    {% if report.last_accessed %}
                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                        Last accessed {{ report.last_accessed|timesince }} ago • Viewed {{ report.access_count }} time{{ report.access_count|pluralize }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        <div style="display: grid; gap: 1rem;">
            <a href="{% url 'reports:view_report' cycle.id %}" class="btn btn-primary" style="justify-content: center;">
                <svg style="width: 20px; height: 20px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                View Report (Admin)
            </a>
            {% if report.access_token %}
            <a href="{% url 'reports:reviewee_report' report.access_token %}" class="btn btn-secondary" style="justify-content: center;">
                <svg style="width: 20px; height: 20px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                View Report (Reviewee View)
            </a>
            <form method="post" action="{% url 'send_report_email' cycle.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success" style="width: 100%; justify-content: center;">
                    <svg style="width: 20px; height: 20px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    Send Report to {{ cycle.reviewee.name }}
                </button>
            </form>
            {% endif %}
            <a href="{% url 'generate_report' cycle.id %}" class="btn btn-secondary" style="justify-content: center;">
                <svg style="width: 20px; height: 20px; margin-right: 8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                Regenerate Report
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Stats Summary (Compact for completed cycles) -->
<details style="margin-bottom: 2rem;">
    <summary style="cursor: pointer; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; font-weight: 600; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
        <svg style="width: 16px; height: 16px; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        Review Completion Details
        <span style="color: var(--text-secondary); font-weight: normal; margin-left: auto;">{{ completed_tokens }} of {{ total_tokens }} completed ({{ completion_rate|floatformat:0 }}%)</span>
    </summary>
    <div style="padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
        <div class="stats-grid">
            <div class="card">
                <div class="card-body stat-card-content">
                    <div class="stat-number primary">{{ total_tokens }}</div>
                    <div class="stat-label">Total Reviewers</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body stat-card-content">
                    <div class="stat-number success">{{ completed_tokens }}</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body stat-card-content">
                    <div class="stat-number secondary">{{ completion_rate|floatformat:0 }}%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>
        </div>
    </div>
</details>

{% else %}
<!-- Stats Cards (Prominent for active cycles) -->
<div class="stats-grid" style="margin-bottom: 2rem;">
    <div class="card">
        <div class="card-body stat-card-content">
            <div class="stat-number primary">{{ total_tokens }}</div>
            <div class="stat-label">Total Reviewers</div>
        </div>
    </div>

    <div class="card">
        <div class="card-body stat-card-content">
            <div class="stat-number success">{{ completed_tokens }}</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>

    <div class="card">
        <div class="card-body stat-card-content">
            <div class="stat-number warning">{{ total_tokens|add:"-"|add:completed_tokens }}</div>
            <div class="stat-label">Pending</div>
        </div>
    </div>

    <div class="card">
        <div class="card-body stat-card-content">
            <div class="stat-number secondary">{{ completion_rate|floatformat:0 }}%</div>
            <div class="stat-label">Completion Rate</div>
        </div>
    </div>
</div>
{% endif %}

{% if cycle.status == 'active' %}
<!-- Progress Bar (Active cycles only) -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        {% if claimed_tokens > 0 %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <div style="font-weight: 500;">Progress</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                {{ completed_tokens }} of {{ claimed_tokens }} in progress ({{ claimed_completion_rate|floatformat:1 }}%)
                • {{ completed_tokens }} of {{ total_tokens }} total ({{ completion_rate|floatformat:1 }}%)
            </div>
        </div>
        <div class="progress" style="height: 24px; border-radius: 12px;">
            <div class="progress-bar" style="width: {% if claimed_completion_rate > 0 %}{{ claimed_completion_rate }}{% else %}2{% endif %}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                {% if claimed_completion_rate > 15 %}{{ completed_tokens }} / {{ claimed_tokens }}{% endif %}
            </div>
        </div>
        {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <div style="font-weight: 500;">Progress</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">{{ completed_tokens }} / {{ total_tokens }} ({{ completion_rate|floatformat:1 }}%)</div>
        </div>
        <div class="progress" style="height: 24px; border-radius: 12px;">
            <div class="progress-bar" style="width: {% if completion_rate > 0 %}{{ completion_rate }}{% else %}2{% endif %}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                {% if completion_rate > 15 %}{{ completed_tokens }} / {{ total_tokens }}{% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Invitation Links (Active cycles only) -->
<details style="margin-bottom: 2rem;" {% if email_invited_count == 0 %}open{% endif %}>
    <summary style="cursor: pointer; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; font-weight: 600; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
        <svg style="width: 16px; height: 16px; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        Invitation Links
        {% if email_invited_count > 0 %}
        <span style="color: var(--text-secondary); font-weight: normal; margin-left: auto; font-size: 0.875rem;">Alternative to email invites</span>
        {% endif %}
    </summary>
    <div style="padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
        <p style="color: #64748b; margin-bottom: 1.5rem;">
            Share these links with reviewers. Each link will randomly assign an available token from the category.
            Reviewers can bookmark their feedback link or return later - progress is saved automatically.
        </p>

        <div style="display: grid; gap: 1rem;">
            {% if cycle.invitation_token_self %}
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Self Assessment</div>
                    <a href="{% url 'reviews:claim_token' invitation_token=cycle.invitation_token_self %}" target="_blank" id="invite-self" style="font-size: 0.875rem; color: var(--primary); text-decoration: none; background: var(--bg-card); padding: 0.5rem; border-radius: 4px; display: block; overflow-x: auto; transition: background 0.2s;">
                        {{ request.scheme }}://{{ request.get_host }}{% url 'reviews:claim_token' invitation_token=cycle.invitation_token_self %}
                        <svg style="display: inline-block; width: 14px; height: 14px; margin-left: 4px; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    </a>
                </div>
                <button onclick="copyInvitationLink('self')" class="btn btn-sm btn-secondary" style="white-space: nowrap;">
                    Copy Link
                </button>
            </div>
            {% endif %}

            {% if cycle.invitation_token_peer %}
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Peer Review</div>
                    <code id="invite-peer" style="font-size: 0.875rem; color: var(--text-secondary); background: var(--bg-card); padding: 0.5rem; border-radius: 4px; display: block; overflow-x: auto;">{{ request.scheme }}://{{ request.get_host }}{% url 'reviews:claim_token' invitation_token=cycle.invitation_token_peer %}</code>
                </div>
                <button onclick="copyInvitationLink('peer')" class="btn btn-sm btn-secondary" style="white-space: nowrap;">
                    Copy Link
                </button>
            </div>
            {% endif %}

            {% if cycle.invitation_token_manager %}
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Manager Review</div>
                    <code id="invite-manager" style="font-size: 0.875rem; color: var(--text-secondary); background: var(--bg-card); padding: 0.5rem; border-radius: 4px; display: block; overflow-x: auto;">{{ request.scheme }}://{{ request.get_host }}{% url 'reviews:claim_token' invitation_token=cycle.invitation_token_manager %}</code>
                </div>
                <button onclick="copyInvitationLink('manager')" class="btn btn-sm btn-secondary" style="white-space: nowrap;">
                    Copy Link
                </button>
            </div>
            {% endif %}

            {% if cycle.invitation_token_direct_report %}
            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-light); border-radius: 6px;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Direct Report Review</div>
                    <code id="invite-direct_report" style="font-size: 0.875rem; color: var(--text-secondary); background: var(--bg-card); padding: 0.5rem; border-radius: 4px; display: block; overflow-x: auto;">{{ request.scheme }}://{{ request.get_host }}{% url 'reviews:claim_token' invitation_token=cycle.invitation_token_direct_report %}</code>
                </div>
                <button onclick="copyInvitationLink('direct_report')" class="btn btn-sm btn-secondary" style="white-space: nowrap;">
                    Copy Link
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</details>
{% endif %}

<!-- Reviewer Response Status -->
{% if cycle.status == 'completed' %}
<details style="margin-bottom: 2rem;">
    <summary style="cursor: pointer; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; font-weight: 600; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
        <svg style="width: 16px; height: 16px; transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        Reviewer Response Status
        <span style="color: var(--text-secondary); font-weight: normal; margin-left: auto;">{{ total_tokens }} reviewer{{ total_tokens|pluralize }}</span>
    </summary>
    <div style="padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
{% else %}
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h2 class="card-title">Reviewer Response Status</h2>
    </div>
    <div class="card-body">
{% endif %}
        {% if tokens_by_category %}
        <div style="display: grid; gap: 2rem;">
            {% for category, tokens in tokens_by_category.items %}
            <div>
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    {{ category }}
                    <span class="badge badge-secondary">{{ tokens|length }}</span>
                </h3>

                <div style="background: var(--bg-light); border-radius: 8px; padding: 1rem;">
                    <div class="table-wrapper">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th style="border: none;">Reviewer</th>
                                <th style="border: none;">Invitation Status</th>
                                <th style="border: none;">Response Status</th>
                                <th style="border: none;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for token in tokens %}
                            <tr data-email="{{ token.reviewer_email|default:'' }}" data-sent="{% if token.invitation_sent_at %}yes{% else %}no{% endif %}">
                                <td style="font-size: 0.875rem; border-bottom: 1px solid var(--border);" class="reviewer-col">
                                    {% if token.reviewer_email %}
                                    <span style="color: var(--success); font-weight: 500;">✓ Invited by email</span>
                                    {% elif token.claimed_at or token.completed_at %}
                                    <span style="color: var(--text-secondary);">Via invite link</span>
                                    {% else %}
                                    <span style="color: var(--text-secondary);">Awaiting claim</span>
                                    {% endif %}
                                </td>
                                <td style="border-bottom: 1px solid var(--border); font-size: 0.875rem;">
                                    {% if token.invitation_sent_at %}
                                    <span style="color: var(--success);">Sent {{ token.invitation_sent_at|date:"M d, Y" }}</span>
                                    {% elif token.reviewer_email %}
                                    <span style="color: var(--text-secondary);">Ready to send</span>
                                    {% else %}
                                    <span style="color: var(--text-secondary);">—</span>
                                    {% endif %}
                                </td>
                                <td style="border-bottom: 1px solid var(--border); font-size: 0.875rem;">
                                    {% if token.completed_at %}
                                    <span style="color: var(--insight-perception); font-weight: 500;">✓ Completed {{ token.completed_at|date:"M d, Y" }}</span>
                                    {% elif token.claimed_at %}
                                    <div>
                                        <span style="color: var(--warning); font-weight: 500;">In Progress</span>
                                        {% if token.last_reminder_sent_at %}
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                            Reminder sent {{ token.last_reminder_sent_at|date:"M d, Y" }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% elif token.invitation_sent_at %}
                                    <div>
                                        <span style="color: var(--text-secondary);">Pending</span>
                                        {% if token.last_reminder_sent_at %}
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                            Reminder sent {{ token.last_reminder_sent_at|date:"M d, Y" }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span style="color: var(--text-secondary);">—</span>
                                    {% endif %}
                                </td>
                                <td style="border-bottom: 1px solid var(--border);">
                                    {% if token.reviewer_email and not token.invitation_sent_at %}
                                    <div style="display: flex; gap: 0.5rem;">
                                        <form method="post" action="{% url 'send_invitations' cycle.id %}" style="display: inline; margin: 0;">
                                            {% csrf_token %}
                                            <input type="hidden" name="token_id" value="{{ token.id }}">
                                            <button type="submit" class="btn btn-sm btn-primary" style="white-space: nowrap;">
                                                Send Invite
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'remove_reviewer_token' cycle.id token.id %}" style="display: inline; margin: 0;" onsubmit="return confirmRemoveReviewer(this);">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" style="white-space: nowrap;">
                                                Remove
                                            </button>
                                        </form>
                                    </div>
                                    {% elif token.invitation_sent_at and not token.is_completed and not token.claimed_at %}
                                    <div style="display: flex; gap: 0.5rem;">
                                        <form method="post" action="{% url 'send_individual_reminder' cycle.id token.id %}" style="display: inline; margin: 0;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-warning" style="white-space: nowrap;">
                                                Send Reminder
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'remove_reviewer_token' cycle.id token.id %}" style="display: inline; margin: 0;" onsubmit="return confirmRemoveReviewer(this);">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" style="white-space: nowrap;">
                                                Remove
                                            </button>
                                        </form>
                                    </div>
                                    {% elif token.invitation_sent_at and not token.is_completed and token.claimed_at %}
                                    <form method="post" action="{% url 'send_individual_reminder' cycle.id token.id %}" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-warning" style="white-space: nowrap;">
                                            Send Reminder
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if pending_invites > 0 %}
        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border);">
            <form method="post" action="{% url 'send_invitations' cycle.id %}" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                {% csrf_token %}
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">{{ pending_invites }} pending invitation{{ pending_invites|pluralize }}</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Send invitation emails to all reviewers who have been assigned but not sent invites yet</div>
                </div>
                <button type="submit" class="btn btn-primary" style="white-space: nowrap;">Send All Pending Invites</button>
            </form>
        </div>
        {% endif %}

        {% if pending_reminders > 0 %}
        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: 8px; border: 1px solid var(--border);">
            <form method="post" action="{% url 'send_reminder' cycle.id %}" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                {% csrf_token %}
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">{{ pending_reminders }} unfinished review{{ pending_reminders|pluralize }}</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Send reminder emails to all reviewers who have been sent invitations but haven't completed their feedback yet</div>
                </div>
                <button type="submit" class="btn btn-secondary">Remind All Pending Reviewers</button>
            </form>
        </div>
        {% endif %}
        {% else %}
        <p style="color: var(--text-secondary); text-align: center; padding: 2rem 0;">No reviewers invited yet. <a href="{% url 'manage_invitations' cycle.id %}">Invite reviewers</a></p>
        {% endif %}
{% if cycle.status == 'completed' %}
    </div>
</details>
{% else %}
    </div>
</div>
{% endif %}

<script>
// Mask email addresses to show partial info: first char + **** + last char before @
function maskEmail(email) {
    if (!email) return '';

    const atIndex = email.indexOf('@');
    if (atIndex <= 0) return email;

    const localPart = email.substring(0, atIndex);
    const domain = email.substring(atIndex);

    if (localPart.length <= 2) {
        return localPart[0] + '****' + domain;
    }

    return localPart[0] + '****' + localPart[localPart.length - 1] + domain;
}

// Update reviewer column to show masked emails
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('tr[data-email]').forEach(row => {
        const email = row.getAttribute('data-email');
        const reviewerCol = row.querySelector('.reviewer-col');
        const hasSent = row.getAttribute('data-sent') === 'yes';

        if (email && reviewerCol) {
            const span = reviewerCol.querySelector('span');

            if (!hasSent) {
                // Show masked email for pending invitations
                const maskedEmail = maskEmail(email);
                span.innerHTML = `<span style="color: var(--text-secondary); font-family: monospace; font-size: 0.875rem;">${maskedEmail}</span>`;
            }
        }
    });
});
</script>

<!-- Actions -->
{% if cycle.status == 'active' %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Actions</h2>
    </div>
    <div class="card-body">
        <div class="action-grid">
            <a href="{% url 'manage_invitations' cycle.id %}" class="btn btn-primary">Manage Invitations</a>

            {% if pending_invites > 0 %}
            <form method="post" action="{% url 'send_invitations' cycle.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Send Pending Invites ({{ pending_invites }})
                </button>
            </form>
            {% endif %}

            {% if total_tokens|add:"-"|add:completed_tokens > 0 %}
            <a href="{% url 'send_reminder_form' cycle.id %}" class="btn btn-warning" style="color: white;">
                Send Reminders ({{ total_tokens|add:"-"|add:completed_tokens }})
            </a>
            {% endif %}

            {% if report_exists %}
            <a href="{% url 'reports:view_report' cycle.id %}" class="btn btn-secondary">View Report (Admin)</a>
            <a href="{% url 'generate_report' cycle.id %}" class="btn btn-secondary">Regenerate Report</a>
            {% else %}
            <a href="{% url 'generate_report' cycle.id %}" class="btn btn-secondary">Generate Report</a>
            {% endif %}

            {% if user.is_superuser %}
            <a href="/admin/reviews/reviewcycle/{{ cycle.id }}/change/" class="btn btn-secondary">
                Edit in Django Admin
            </a>
            {% endif %}

            <form method="post" action="{% url 'close_cycle' cycle.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-secondary" style="width: 100%;">
                    Close Cycle & Generate Report
                </button>
            </form>
        </div>
    </div>
</div>
{% else %}
<!-- Additional Actions for Completed Cycles -->
{% if user.is_superuser %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Additional Actions</h2>
    </div>
    <div class="card-body">
        <div class="action-grid">
            <a href="/admin/reviews/reviewcycle/{{ cycle.id }}/change/" class="btn btn-secondary">
                Edit in Django Admin
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Confirmation Modal -->
<div id="confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">Confirm Action</h2>
        <p id="confirm-message" style="color: var(--text-secondary); margin-bottom: 2rem;"></p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="closeConfirmModal()" class="btn btn-secondary">
                Cancel
            </button>
            <button id="confirm-action-btn" class="btn btn-danger">
                Remove
            </button>
        </div>
    </div>
</div>

<style>
details[open] > summary svg {
    transform: rotate(90deg);
}
</style>

<script>
function copyInvitationLink(category) {
    const codeElement = document.getElementById(`invite-${category}`);
    const url = codeElement.textContent.trim();
    navigator.clipboard.writeText(url).then(() => {
        showCopyFeedback('Invitation link copied to clipboard');
    }).catch(() => {
        showCopyFeedback('Failed to copy. URL: ' + url);
    });
}

function copyToken(token) {
    const url = `${window.location.origin}/feedback/${token}/`;
    navigator.clipboard.writeText(url).then(() => {
        showCopyFeedback('Link copied to clipboard');
    }).catch(() => {
        showCopyFeedback('Failed to copy. URL: ' + url);
    });
}

function showCopyFeedback(message) {
    const existing = document.getElementById('copy-feedback');
    if (existing) existing.remove();

    const feedback = document.createElement('div');
    feedback.id = 'copy-feedback';
    feedback.className = 'copy-feedback';
    feedback.textContent = message;
    document.body.appendChild(feedback);

    setTimeout(() => feedback.classList.add('show'), 10);
    setTimeout(() => {
        feedback.classList.remove('show');
        setTimeout(() => feedback.remove(), 300);
    }, 2000);
}

// Confirmation modal functions
function showConfirmModal(message, onConfirm) {
    const modal = document.getElementById('confirm-modal');
    const messageEl = document.getElementById('confirm-message');
    const confirmBtn = document.getElementById('confirm-action-btn');

    messageEl.textContent = message;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Remove old listeners and add new one
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.addEventListener('click', function() {
        onConfirm();
        closeConfirmModal();
    });
}

function closeConfirmModal() {
    const modal = document.getElementById('confirm-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Handle remove reviewer confirmation
function confirmRemoveReviewer(form) {
    showConfirmModal(
        'Are you sure you want to remove this reviewer from the cycle?',
        function() {
            form.submit();
        }
    );
    return false;
}
</script>
{% endblock %}
